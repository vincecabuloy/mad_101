{% extends "layout/base_user.html" %} 
{% block content %}
<div class="container mt-5">
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <form method="GET" action="{{ url_for('customer.shop') }}" class="row g-3 align-items-end">
        <div class="col-md-5">
          <label class="form-label fw-bold small">Search Books</label>
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" name="search" class="form-control" placeholder="Search by title or author..." value="{{ request.args.get('search', '') }}">
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold small">Category</label>
          <select name="category" class="form-select">
            <option value="">All Categories</option>
            {% for cat in categories %}
            <option value="{{ cat.category_id }}" {% if request.args.get('category') == cat.category_id|string %}selected{% endif %}>
              {{ cat.category_name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">
            <i class="bi bi-filter"></i> Apply Filters
          </button>
          <a href="{{ url_for('customer.shop') }}" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">Our Collection</h2>
    <span class="text-muted small">Showing {{ products|length }} products</span>
  </div>

  <div class="row">
    {% if products %} 
      {% for product in products %}
      <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
        <div class="card h-100 shadow-sm position-relative product-card">
          <div style="height: 250px; overflow: hidden">
            {% if product.image %}
              {% set clean_filename = product.image.split('\\')[-1].split('/')[-1] %}
              <img src="{{ url_for('static', filename='img/' + clean_filename) }}" class="card-img-top" style="object-fit: cover; height: 100%; width: 100%" />
            {% else %}
              <img src="{{ url_for('static', filename='img/default-book.png') }}" class="card-img-top" />
            {% endif %}
          </div>
          
          <div class="card-body d-flex flex-column">
            <h5 class="card-title h6">
              <a href="{{ url_for('customer.shop') }}/{{ product.product_id }}" class="stretched-link text-decoration-none text-dark">
                {{ product.title }}
              </a>
            </h5>
            <p class="text-muted small mb-1">By {{ product.author }}</p>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-light text-dark border" style="position: relative; z-index: 3">
                    {{ product.category_name }}
                </span>
                
                {% if product.stock > 10 %}
                    <span class="badge bg-success-subtle text-success small">In Stock</span>
                {% elif product.stock > 0 %}
                    <span class="badge bg-warning-subtle text-warning small">Only {{ product.stock }} left</span>
                {% else %}
                    <span class="badge bg-danger-subtle text-danger small">Out of Stock</span>
                {% endif %}
            </div>

            <div class="mt-auto">
  <div class="mb-2">
    {% if product.stock > 0 %}
      <small class="fw-bold {% if product.stock < 5 %}text-danger{% elif product.stock < 15 %}text-warning{% else %}text-muted{% endif %}">
        <i class="bi bi-box-seam me-1"></i>
        {{ product.stock }} units available
      </small>
    {% else %}
      <small class="text-danger fw-bold">
        <i class="bi bi-x-circle me-1"></i>
        Temporarily out of stock
      </small>
    {% endif %}
  </div>

  <h5 class="text-primary mb-2">â‚±{{ "%.2f"|format(product.price) }}</h5>
  
  <form class="ajax-cart-form" method="POST" action="{{ url_for('customer.add_to_cart') }}" style="position: relative; z-index: 5">
    <input type="hidden" name="product_id" value="{{ product.product_id }}" />
    
    <div class="input-group input-group-sm mb-2">
      <span class="input-group-text bg-light">Qty</span>
      <input type="number" name="quantity" class="form-control text-center" 
             value="1" min="1" max="{{ product.stock }}" {% if product.stock <= 0 %}disabled{% endif %} required>
    </div>

    <button type="submit" class="btn {% if product.stock > 0 %}btn-success{% else %}btn-secondary{% endif %} btn-sm w-100" {% if product.stock <= 0 %}disabled{% endif %}>
      <i class="bi bi-cart-plus"></i> 
      {% if product.stock > 0 %}Add to Cart{% else %}Sold Out{% endif %}
    </button>
  </form>
</div>
          </div>
        </div>
      </div>
      {% endfor %} 
    {% else %}
      <div class="col-12 text-center py-5">
        <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
        <p class="lead mt-3">No books found matching your criteria.</p>
        <a href="{{ url_for('customer.shop') }}" class="btn btn-primary">View All Books</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content text-center border-0 shadow-lg">
      <div class="modal-body p-4">
        <i
          class="bi bi-check-circle-fill text-success"
          style="font-size: 3.5rem"
        ></i>
        <h5 class="fw-bold mt-3">Success!</h5>
        <p class="text-muted small">Item added to your cart.</p>
        <div class="d-grid gap-2 mt-3">
          <button
            type="button"
            class="btn btn-light btn-sm"
            data-bs-dismiss="modal"
          >
            Continue
          </button>
          <a
            href="{{ url_for('customer.view_cart') }}"
            class="btn btn-primary btn-sm"
            >Go to Cart</a
          >
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll(".ajax-cart-form").forEach((form) => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      fetch(this.action, {
        method: "POST",
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          var myModal = new bootstrap.Modal(document.getElementById('cartModal'));
          myModal.show();
        } else {
          alert(data.message || "Error adding to cart.");
        }
      })
      .catch(error => console.error("Error:", error));
    });
  });
</script>
{% endblock %}