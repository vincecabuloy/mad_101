{% extends "layout/base_user.html" %} {% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-box-seam me-2 text-primary"></i> My Active Orders
    </h2>
    <div>
      <a href="{{ url_for('customer.shop') }}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg"></i> New Order
      </a>
    </div>
  </div>

  {% if orders %}
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light text-muted small text-uppercase">
          <tr>
            <th class="ps-4">Order ID</th>
            <th>Shipping Info</th>
            <th>Date</th>
            <th>Total Amount</th>
            <th>Payment</th>
            <th>Status</th>
            <th class="text-end pe-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td class="ps-4">
              <span class="fw-bold text-dark">#ORD-{{ order.order_id }}</span>
            </td>

            <td>
              <div class="fw-bold text-dark" style="font-size: 0.9rem">
                {{ order.name }}
              </div>
              <div
                class="text-muted small"
                style="max-width: 200px; line-height: 1.2"
              >
                {{ order.address }}
              </div>
            </td>

            <td>
              <div class="small">
                {{ order.order_date.strftime('%b %d, %Y') }}
              </div>
              <div class="text-muted" style="font-size: 0.75rem">
                {{ order.order_date.strftime('%I:%M %p') }}
              </div>
            </td>

            <td>
              <span class="fw-bold text-primary"
                >â‚±{{ "%.2f"|format(order.total_amount) }}</span
              >
            </td>

            <td>
              <div class="d-flex align-items-center">
                <span>{{ order.payment_method }}</span>
                {% if order.payment_proof %}
                <a
                  href="{{ url_for('static', filename='img/payments/' + order.payment_proof) }}"
                  target="_blank"
                  class="ms-2 text-info"
                  title="View Proof"
                >
                  <i class="bi bi-file-earmark-image fs-5"></i>
                </a>
                {% endif %}
              </div>
            </td>

            <td>
              {% if order.status == 'Pending' %}
              <span
                class="badge rounded-pill bg-warning-subtle text-warning border px-3"
                >Pending</span
              >
              {% elif order.status == 'Shipped' %}
              <span
                class="badge rounded-pill bg-info-subtle text-info border px-3"
                >Shipped</span
              >
              {% elif order.status == 'Delivered' %}
              <span
                class="badge rounded-pill bg-success-subtle text-success border px-3"
                >Delivered</span
              >
              {% endif %}
            </td>

            <td class="text-end pe-4">
              <div class="btn-group">
                <button
                  class="btn btn-sm btn-light border text-primary fw-bold px-3"
                >
                  Details
                </button>

                {% if order.status == 'Pending' %}
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger fw-bold ms-2"
                  data-bs-toggle="modal"
                  data-bs-target="#cancelModal{{ order.order_id }}"
                >
                  Cancel
                </button>
                {% endif %}
              </div>

              {% if order.status == 'Pending' %}
              <div
                class="modal fade text-start"
                id="cancelModal{{ order.order_id }}"
                tabindex="-1"
              >
                <div class="modal-dialog modal-dialog-centered">
                  <form
                    action="{{ url_for('customer.cancel_order', order_id=order.order_id) }}"
                    method="POST"
                  >
                    <div class="modal-content border-0 shadow">
                      <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                          Cancel Order #ORD-{{ order.order_id }}
                        </h5>
                        <button
                          type="button"
                          class="btn-close btn-close-white"
                          data-bs-dismiss="modal"
                        ></button>
                      </div>
                      <div class="modal-body">
                        <p class="text-dark">
                          Are you sure you want to cancel this order? This
                          action will return the items to our stock and cannot
                          be undone.
                        </p>

                        <label
                          class="form-label fw-bold small text-muted text-uppercase"
                          >Reason for cancellation:</label
                        >
                        <select
                          name="cancel_reason"
                          class="form-select"
                          required
                        >
                          <option value="" disabled selected>
                            Select a reason...
                          </option>
                          <option value="Changed my mind">
                            Changed my mind
                          </option>
                          <option value="Mistake in order details">
                            Mistake in order details
                          </option>
                          <option value="Found a better price elsewhere">
                            Found a better price elsewhere
                          </option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                      <div class="modal-footer bg-light">
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Keep Order
                        </button>
                        <button type="submit" class="btn btn-danger">
                          Confirm Cancellation
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="text-center py-5 border rounded bg-white shadow-sm">
    <i class="bi bi-bag-x text-muted" style="font-size: 4rem"></i>
    <h4 class="mt-3">No active orders found</h4>
    <p class="text-muted">You don't have any ongoing orders at the moment.</p>
    <a href="{{ url_for('customer.shop') }}" class="btn btn-primary px-4 mt-2"
      >Browse Books</a
    >
  </div>
  {% endif %}
</div>
{% endblock %}
