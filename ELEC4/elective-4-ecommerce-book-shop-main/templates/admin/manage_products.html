{% extends "layout/base_admin.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Manage Products</h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('product.add_product') }}" class="btn btn-primary">+ Add Product</a>

    <form method="get" action="{{ url_for('product.manage_products') }}" id="filterForm" class="d-flex" style="gap: 10px;">
      <input
        type="text"
        name="search"
        class="form-control"
        placeholder="Search by title or author..."
        value="{{ search }}"
        id="searchInput"
      />

      <select name="category_id" class="form-select" id="categorySelect">
        <option value="all">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat.category_id }}"
          {% if selected_category == cat.category_id|string %}selected{% endif %}>
          {{ cat.category_name }}
        </option>
        {% endfor %}
      </select>

      <a href="{{ url_for('product.manage_products') }}" class="btn btn-secondary">Reset</a>
    </form>
  </div>

  <table class="table table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Author</th>
        <th>Description</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Category</th>
        <th>Image</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% if products %}
        {% for product in products %}
        <tr>
          <td>{{ product.product_id }}</td>
          <td>{{ product.title }}</td>
          <td>{{ product.author or '-' }}</td>
          <td>{{ product.description or '-' }}</td>
          <td>â‚±{{ '%.2f'|format(product.price) }}</td>
          <td>{{ product.stock }}</td>
          <td>{{ product.category_name or 'Uncategorized' }}</td>
          <td>
            {% if product.image %}
              <img src="{{ product.image }}" width="60" />
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('product.edit_product', id=product.product_id) }}" class="btn btn-warning btn-sm">Edit</a>
            <form
              action="{{ url_for('product.delete_product', id=product.product_id) }}"
              method="POST"
              style="display: inline"
            >
              <button
                type="submit"
                class="btn btn-danger btn-sm"
                onclick="return confirm('Delete this product?')"
              >
                Delete
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="9" class="text-center">No products found.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Auto Filter Script -->
<script>
  const categorySelect = document.getElementById('categorySelect');
  const searchInput = document.getElementById('searchInput');
  const filterForm = document.getElementById('filterForm');

  // Auto filter when changing category
  categorySelect.addEventListener('change', () => {
    filterForm.submit();
  });

  // Auto search when typing (after delay)
  let searchTimeout;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => filterForm.submit(), 600);
  });
</script>
{% endblock %}
