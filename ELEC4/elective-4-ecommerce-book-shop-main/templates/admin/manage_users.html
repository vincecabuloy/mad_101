{% extends "layout/base_admin.html" %}
{% block title %}Manage Users{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">ðŸ‘¥ Manage Users</h2>
  <p>View, activate/deactivate, and reset customer passwords.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="mt-3">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <!-- Search & Filter Form -->
  <form method="get" id="filterForm" class="row g-2 mb-3">
    <div class="col-md-5">
      <input
        type="text"
        name="search"
        id="searchInput"
        class="form-control"
        placeholder="Search by name or email..."
        value="{{ search_query }}"
      />
    </div>
    <div class="col-md-3">
      <select
        name="status"
        id="statusSelect"
        class="form-select"
      >
        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>
          All Users
        </option>
        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>
          Active
        </option>
        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>
          Inactive
        </option>
      </select>
    </div>
    <div class="col-md-2">
      <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary w-100">Reset</a>
    </div>
  </form>

  <!-- Users Table -->
  <table class="table table-bordered table-striped mt-3">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if users %}
      {% for user in users %}
      <tr>
        <td>{{ user.user_id }}</td>
        <td>{{ user.name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.phone or '-' }}</td>
        <td>
          {% if user.status == 'active' %}
          <span class="badge bg-success">Active</span>
          {% else %}
          <span class="badge bg-secondary">Inactive</span>
          {% endif %}
        </td>
        <td>
          {% if user.status == 'active' %}
          <a
            href="{{ url_for('admin.toggle_user_status', user_id=user.user_id, action='deactivate') }}"
            class="btn btn-sm btn-warning"
            >Deactivate</a>
          {% else %}
          <a
            href="{{ url_for('admin.toggle_user_status', user_id=user.user_id, action='activate') }}"
            class="btn btn-sm btn-success"
            >Activate</a>
          {% endif %}
          <a
            href="{{ url_for('admin.reset_user_password', user_id=user.user_id) }}"
            class="btn btn-sm btn-danger"
            >Reset Password</a>
        </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">
          No users found.
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Auto Filter Script -->
<script>
  const filterForm = document.getElementById('filterForm');
  const searchInput = document.getElementById('searchInput');
  const statusSelect = document.getElementById('statusSelect');

  // Auto submit when status changes
  statusSelect.addEventListener('change', () => {
    filterForm.submit();
  });

  // Auto search after typing delay
  let searchTimeout;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      filterForm.submit();
    }, 600);
  });
</script>
{% endblock %}
